var colorData = {
    "0": {
        "name": "Black",
        "color": "#000000",
        "style": "background-color:#000000;color:#FFF"
    },
    "1": {
        "name": "90% Black",
        "color": "#1A1A1A",
        "style": "background-color:#1A1A1A;color:#FFF"
    },
    "2": {
        "name": "80% Black",
        "color": "#333333",
        "style": "background-color:#333333;color:#FFF"
    },
    "3": {
        "name": "70% Black",
        "color": "#4D4D4D",
        "style": "background-color:#4D4D4D;color:#FFF"
    },
    "4": {
        "name": "60% Black",
        "color": "#666666",
        "style": "background-color:#666666;color:#FFF"
    },
    "5": {
        "name": "50% Black",
        "color": "#808080",
        "style": "background-color:#808080;color:#FFF"
    },
    "6": {
        "name": "40% Black",
        "color": "#999999",
        "style": "background-color:#999999;color:#FFF"
    },
    "7": {
        "name": "30% Black",
        "color": "#B3B3B3",
        "style": "background-color:#B3B3B3;color:#000"
    },
    "8": {
        "name": "20% Black",
        "color": "#CCCCCC",
        "style": "background-color:#CCCCCC;color:#000"
    },
    "9": {
        "name": "10% Black",
        "color": "#E6E6E6",
        "style": "background-color:#E6E6E6;color:#000"
    },
    "10": {
        "name": "White",
        "color": "#FFFFFF",
        "style": "background-color:#FFFFFF;color:#000"
    },
    "11": {
        "name": "Blue",
        "color": "#0000FF",
        "style": "background-color:#0000FF;color:#FFF"
    },
    "12": {
        "name": "Cyan",
        "color": "#00FFFF",
        "style": "background-color:#00FFFF;color:#FFF"
    },
    "13": {
        "name": "Green",
        "color": "#00FF00",
        "style": "background-color:#00FF00;color:#FFF"
    },
    "14": {
        "name": "Yellow",
        "color": "#FFFF00",
        "style": "background-color:#FFFF00;color:#FFF"
    },
    "15": {
        "name": "Red",
        "color": "#FF0000",
        "style": "background-color:#FF0000;color:#FFF"
    },
    "16": {
        "name": "Magenta",
        "color": "#FF00FF",
        "style": "background-color:#FF00FF;color:#FFF"
    },
    "17": {
        "name": "Purple",
        "color": "#9900CC",
        "style": "background-color:#9900CC;color:#FFF"
    },
    "18": {
        "name": "Orange",
        "color": "#FF6600",
        "style": "background-color:#FF6600;color:#FFF"
    },
    "19": {
        "name": "Pink",
        "color": "#FF99CC",
        "style": "background-color:#FF99CC;color:#000"
    },
    "20": {
        "name": "Dark Brown",
        "color": "#663333",
        "style": "background-color:#663333;color:#FFF"
    },
    "21": {
        "name": "Powder Blue",
        "color": "#CCCCFF",
        "style": "background-color:#CCCCFF;color:#000"
    },
    "22": {
        "name": "Pastel Blue",
        "color": "#9999FF",
        "style": "background-color:#9999FF;color:#000"
    },
    "23": {
        "name": "Baby Blue",
        "color": "#6699FF",
        "style": "background-color:#6699FF;color:#000"
    },
    "24": {
        "name": "Electric Blue",
        "color": "#6666FF",
        "style": "background-color:#6666FF;color:#000"
    },
    "25": {
        "name": "Twilight Blue",
        "color": "#6666CC",
        "style": "background-color:#6666CC;color:#000"
    },
    "26": {
        "name": "Navy Blue",
        "color": "#003399",
        "style": "background-color:#003399;color:#FFF"
    },
    "27": {
        "name": "Deep Navy Blue",
        "color": "#000066",
        "style": "background-color:#000066;color:#FFF"
    },
    "28": {
        "name": "Desert Blue",
        "color": "#336699",
        "style": "background-color:#336699;color:#FFF"
    },
    "29": {
        "name": "Sky Blue",
        "color": "#00CCFF",
        "style": "background-color:#00CCFF;color:#FFF"
    },
    "30": {
        "name": "Ice Blue",
        "color": "#99FFFF",
        "style": "background-color:#99FFFF;color:#000"
    },
    "31": {
        "name": "Light BlueGreen",
        "color": "#99CCCC",
        "style": "background-color:#99CCCC;color:#000"
    },
    "32": {
        "name": "Ocean Green",
        "color": "#669999",
        "style": "background-color:#669999;color:#FFF"
    },
    "33": {
        "name": "Moss Green",
        "color": "#336666",
        "style": "background-color:#336666;color:#FFF"
    },
    "34": {
        "name": "Dark Green",
        "color": "#003333",
        "style": "background-color:#003333;color:#FFF"
    },
    "35": {
        "name": "Forest Green",
        "color": "#006633",
        "style": "background-color:#006633;color:#FFF"
    },
    "36": {
        "name": "Grass Green",
        "color": "#009933",
        "style": "background-color:#009933;color:#FFF"
    },
    "37": {
        "name": "Kentucky Green",
        "color": "#339966",
        "style": "background-color:#339966;color:#FFF"
    },
    "38": {
        "name": "Light Green",
        "color": "#33CC66",
        "style": "background-color:#33CC66;color:#FFF"
    },
    "39": {
        "name": "Spring Green",
        "color": "#33CC33",
        "style": "background-color:#33CC33;color:#FFF"
    },
    "40": {
        "name": "Turquoise",
        "color": "#66FFCC",
        "style": "background-color:#66FFCC;color:#000"
    },
    "41": {
        "name": "Sea Green",
        "color": "#33CC99",
        "style": "background-color:#33CC99;color:#FFF"
    },
    "42": {
        "name": "Faded Green",
        "color": "#99CC99",
        "style": "background-color:#99CC99;color:#000"
    },
    "43": {
        "name": "Ghost Green",
        "color": "#CCFFCC",
        "style": "background-color:#CCFFCC;color:#000"
    },
    "44": {
        "name": "Mint Green",
        "color": "#99FF99",
        "style": "background-color:#99FF99;color:#000"
    },
    "45": {
        "name": "Army Green",
        "color": "#669966",
        "style": "background-color:#669966;color:#FFF"
    },
    "46": {
        "name": "Avocado Green",
        "color": "#669933",
        "style": "background-color:#669933;color:#FFF"
    },
    "47": {
        "name": "Martian Green",
        "color": "#99CC33",
        "style": "background-color:#99CC33;color:#FFF"
    },
    "48": {
        "name": "Dull Green",
        "color": "#99CC66",
        "style": "background-color:#99CC66;color:#000"
    },
    "49": {
        "name": "Chartreuse",
        "color": "#99FF00",
        "style": "background-color:#99FF00;color:#FFF"
    },
    "50": {
        "name": "Moon Green",
        "color": "#CCFF66",
        "style": "background-color:#CCFF66;color:#000"
    },
    "51": {
        "name": "Murky Green",
        "color": "#333300",
        "style": "background-color:#333300;color:#FFF"
    },
    "52": {
        "name": "Olive Drab",
        "color": "#666633",
        "style": "background-color:#666633;color:#FFF"
    },
    "53": {
        "name": "Khaki",
        "color": "#999966",
        "style": "background-color:#999966;color:#FFF"
    },
    "54": {
        "name": "Olive",
        "color": "#999933",
        "style": "background-color:#999933;color:#FFF"
    },
    "55": {
        "name": "Banana Yellow",
        "color": "#CCCC33",
        "style": "background-color:#CCCC33;color:#FFF"
    },
    "56": {
        "name": "Light Yellow",
        "color": "#FFFF66",
        "style": "background-color:#FFFF66;color:#000"
    },
    "57": {
        "name": "Chalk",
        "color": "#FFFF99",
        "style": "background-color:#FFFF99;color:#000"
    },
    "58": {
        "name": "Pale Yellow",
        "color": "#FFFFCC",
        "style": "background-color:#FFFFCC;color:#000"
    },
    "59": {
        "name": "Brown",
        "color": "#996633",
        "style": "background-color:#996633;color:#FFF"
    },
    "60": {
        "name": "Red Brown",
        "color": "#CC6633",
        "style": "background-color:#CC6633;color:#FFF"
    },
    "61": {
        "name": "Gold",
        "color": "#CC9933",
        "style": "background-color:#CC9933;color:#FFF"
    },
    "62": {
        "name": "Autumn Orange",
        "color": "#FF6633",
        "style": "background-color:#FF6633;color:#FFF"
    },
    "63": {
        "name": "Light Orange",
        "color": "#FF9933",
        "style": "background-color:#FF9933;color:#FFF"
    },
    "64": {
        "name": "Peach",
        "color": "#FF9966",
        "style": "background-color:#FF9966;color:#000"
    },
    "65": {
        "name": "Deep Yellow",
        "color": "#FFCC00",
        "style": "background-color:#FFCC00;color:#FFF"
    },
    "66": {
        "name": "Sand",
        "color": "#FFCC99",
        "style": "background-color:#FFCC99;color:#000"
    },
    "67": {
        "name": "Walnut",
        "color": "#663300",
        "style": "background-color:#663300;color:#FFF"
    },
    "68": {
        "name": "Ruby Red",
        "color": "#990000",
        "style": "background-color:#990000;color:#FFF"
    },
    "69": {
        "name": "Brick Red",
        "color": "#CC3300",
        "style": "background-color:#CC3300;color:#FFF"
    },
    "70": {
        "name": "Tropical Pink",
        "color": "#FF6666",
        "style": "background-color:#FF6666;color:#000"
    },
    "71": {
        "name": "Soft Pink",
        "color": "#FF9999",
        "style": "background-color:#FF9999;color:#000"
    },
    "72": {
        "name": "Faded Pink",
        "color": "#FFCCCC",
        "style": "background-color:#FFCCCC;color:#000"
    },
    "73": {
        "name": "Crimson",
        "color": "#993366",
        "style": "background-color:#993366;color:#FFF"
    },
    "74": {
        "name": "Regal Red",
        "color": "#CC3366",
        "style": "background-color:#CC3366;color:#FFF"
    },
    "75": {
        "name": "Deep Rose",
        "color": "#CC3399",
        "style": "background-color:#CC3399;color:#FFF"
    },
    "76": {
        "name": "Neon Red",
        "color": "#FF0066",
        "style": "background-color:#FF0066;color:#FFF"
    },
    "77": {
        "name": "Deep Pink",
        "color": "#FF6699",
        "style": "background-color:#FF6699;color:#000"
    },
    "78": {
        "name": "Hot Pink",
        "color": "#FF3399",
        "style": "background-color:#FF3399;color:#FFF"
    },
    "79": {
        "name": "Dusty Rose",
        "color": "#CC6699",
        "style": "background-color:#CC6699;color:#000"
    },
    "80": {
        "name": "Plum",
        "color": "#660066",
        "style": "background-color:#660066;color:#FFF"
    },
    "81": {
        "name": "Deep Violet",
        "color": "#990099",
        "style": "background-color:#990099;color:#FFF"
    },
    "82": {
        "name": "Light Violet",
        "color": "#FF99FF",
        "style": "background-color:#FF99FF;color:#000"
    },
    "83": {
        "name": "Violet",
        "color": "#CC66CC",
        "style": "background-color:#CC66CC;color:#000"
    },
    "84": {
        "name": "Dusty Plum",
        "color": "#996699",
        "style": "background-color:#996699;color:#FFF"
    },
    "85": {
        "name": "Pale Purple",
        "color": "#CC99CC",
        "style": "background-color:#CC99CC;color:#000"
    },
    "86": {
        "name": "Majestic Purple",
        "color": "#9933CC",
        "style": "background-color:#9933CC;color:#FFF"
    },
    "87": {
        "name": "Neon Purple",
        "color": "#CC33FF",
        "style": "background-color:#CC33FF;color:#FFF"
    },
    "88": {
        "name": "Light Purple",
        "color": "#CC66FF",
        "style": "background-color:#CC66FF;color:#000"
    },
    "89": {
        "name": "Twilight Violet",
        "color": "#9966CC",
        "style": "background-color:#9966CC;color:#000"
    },
    "90": {
        "name": "Easter Purple",
        "color": "#CC99FF",
        "style": "background-color:#CC99FF;color:#000"
    },
    "91": {
        "name": "Deep Purple",
        "color": "#330066",
        "style": "background-color:#330066;color:#FFF"
    },
    "92": {
        "name": "Grape",
        "color": "#663399",
        "style": "background-color:#663399;color:#FFF"
    },
    "93": {
        "name": "Blue Violet",
        "color": "#9966FF",
        "style": "background-color:#9966FF;color:#000"
    },
    "94": {
        "name": "Blue Purple",
        "color": "#9900FF",
        "style": "background-color:#9900FF;color:#FFF"
    },
    "95": {
        "name": "Deep River",
        "color": "#6600CC",
        "style": "background-color:#6600CC;color:#FFF"
    },
    "96": {
        "name": "Deep Azure",
        "color": "#6633FF",
        "style": "background-color:#6633FF;color:#FFF"
    },
    "97": {
        "name": "Storm Blue",
        "color": "#330099",
        "style": "background-color:#330099;color:#FFF"
    },
    "98": {
        "name": "Deep Blue",
        "color": "#3300CC",
        "style": "background-color:#3300CC;color:#FFF"
    }
};

var keyHandler = (function() {

    var context = { ctrl: false, shift: false, alt: false },
        keyOrder = ["ctrl", "shift", "alt"],
        stateMap,
        states,
        actions,
        actionHandler,
        isRunning = false,
        contextModes = [],
        contextModeStates = {},
        active,
        keyMap = {
            'a': [65],
            'b': [66],
            'c': [67],
            'd': [68],
            'e': [69],
            'f': [70],
            'g': [71],
            'h': [72],
            'i': [73],
            'j': [74],
            'k': [75],
            'l': [76],
            'm': [77],
            'n': [78],
            'o': [79],
            'p': [80],
            'q': [81],
            'r': [82],
            's': [83],
            't': [84],
            'u': [85],
            'v': [86],
            'w': [87],
            'x': [88],
            'y': [89],
            'z': [90],
            'alt': [18],
            'backspace': [8],
            'ctrl': [17],
            'delete': [46, 40],
            'down': [34, 40],
            'end': [35],
            'enter': [13],
            'esc': [27],
            'f1': [112],
            'f2': [113],
            'f3': [114],
            'f4': [115],
            'f5': [116],
            'f6': [117],
            'f7': [118],
            'f8': [119],
            'f9': [120],
            'f10': [121],
            'f11': [122],
            'f12': [123],
            'home': [36],
            'insert': [45],
            'left': [37],
            'right': [39],
            'shift': [16],
            'space': [32],
            'up': [33, 38],
            'windows': [91]
        },
        keyCodeLookup = {};

    function forEachIn(obj, fn) {
        var index = 0;
        for (var key in obj) {
            if (obj.hasOwnProperty(key)) {
                fn(obj[key], key, index++);
            }
        }
    }

    function keyHandlerError(message, value) {
        this.value = value;
        this.message = message;
        this.toString = function() {
            return this.value + this.message;
        };
    }

    function forEachIn(obj, fn) {
        var index = 0;
        for (var key in obj) {
            if (obj.hasOwnProperty(key)) {
                fn(obj[key], key, index++);
            }
        }
    }

    function getKey(event) {
        var keyCode = event.keyCode;
        if (keyCodeLookup[keyCode]) {
            return keyCodeLookup[keyCode];
        } else {
            throw new keyHandlerError("Unexpected keyCode", keyCode);
        }
    }

    function getKeyState(key) {
        var result = [];
        keyOrder.forEach(function(keyName) {
            if (context[keyName]) {
                result.push(keyName);
            }
        });
        result.push(key);
        return result.join(".");
    }

    function getKeyContext(contextState) {
        var result = [];
        contextModes.forEach(function(contextName) {
            if (contextModeStates[contextName]) {
                result.push(contextName);
            };
        });
        result.push(contextState);
        return result.join(".");
    }

    function setKeyContext(event, isTrue) {
        var key = getKey(event);
        forEachIn(stateMap,
            function(stateKey, state) {
                if (stateKey === key) {
                    states[state] = isTrue;
                }
            });

        if (typeof context[key] !== "undefined") {
            context[key] = isTrue;
            key = null;
        }
        return key;
    }

    function keyDownHandler(event) {

        var key = setKeyContext(event, true);

        if (key !== null && typeof actions[key] !== "undefined") {

            context.ctrl = event.ctrlKey;
            context.shift = event.shiftKey;
            context.alt = event.altKey;

            var match = false;
            for (var i = 0; i < actions[key].length && !match; i++) {
                var isMatch = true;
                var keyContext = actions[key][i].context;
                for (var j = 0; j < keyContext.length && isMatch; j++) {
                    isMatch = context[keyContext[j]] || contextModeStates[keyContext[j]];
                };
                match = isMatch;
                if (isMatch) {
                    return handleEvent(event, key, actions[key][i].action);
                }
            }
        }
        return true;
    }

    function handleEvent(event, key, action) {
        event.preventDefault();
        if (event.stopPropagation) {
            event.stopPropagation();
        }

        if (active) {
            active = false;
            context.ctrl = false;
            context.shift = false;
            context.alt = false;
            actionHandler(action, function () { active = true });
        }
        return false;
    }

    function keyUpHandler(event) {
        setKeyContext(event, false);
    }

    function run(turnOn) {
        if (turnOn) {
            if (!isRunning) {
                document.body.addEventListener("keydown", keyDownHandler);
                document.body.addEventListener("keyup", keyUpHandler);
                isRunning = true;
            }
        } else if (isRunning) {
            document.body.removeEventListener("keydown", keyDownHandler);
            document.body.removeEventListener("keyup", keyUpHandler);
            isRunning = false;
        }
    }

    function getState(state) {
        return states[state];
    }

    function init(map, handler) {
        states = {};
        active = true;
        stateMap = map.states;
        forEachIn(map.states,
            function(state, key) {
                states[key] = false;
            });

        actions = {};
        forEachIn(map.actions,
            function (keyContext, action) {
                var s = keyContext.split(".");
                var key = s.pop();
                if (! actions[key]) {
                    actions[key] = [];
                }
                actions[key].push({ context: s, action: action });
            });
       
        actionHandler = handler;
        run(true);
    };

    function setContext(key, on) {
        if (typeof contextModeStates[key] == "undefined") {
            throw new keyHandlerError("Unexpected Context", key);
        } else {
            contextModeStates[key] = on;
        }
        active = true;
    }

    function setContextModes(newModes) {
        var modes = newModes.split(".");
        contextModes = [];
        contextModeStates = {};
        modes.forEach(function(mode) {
            var isTrue = mode.substr(0, 1) === "+";
            mode = mode.replace("+", "");
            contextModes.push(mode);
            contextModeStates[mode] = isTrue;
        });
    }

    return {
        init: init,
        getState: getState,
        setContext: setContext,
        setContextModes: setContextModes,
        run: run
    }

}());

var colorConverter = (function() {
    /**
 * Converts an RGB color value to HSL. Conversion formula
 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
 * Assumes r, g, and b are contained in the set [0, 255] and
 * returns h, s, and l in the set [0, 1].
 *
 * @param   Number  r       The red color value
 * @param   Number  g       The green color value
 * @param   Number  b       The blue color value
 * @return  Object          The HSL representation
 */
    function rgbToHsl(r, g, b) {
        r /= 255, g /= 255, b /= 255;

        var max = Math.max(r, g, b), min = Math.min(r, g, b);
        var h, s, l = (max + min) / 2;

        if (max === min) {
            h = s = 0; // achromatic
        } else {
            var d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

            switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
            }

            h /= 6;
        }

        return {hue: h, saturation: s, lightness: l};
    }

    /**
     * Converts an HSL color value to RGB. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
     * Assumes h, s, and l are contained in the set [0, 1] and
     * returns r, g, and b in the set [0, 255].
     *
     * @param   Number  h       The hue
     * @param   Number  s       The saturation
     * @param   Number  l       The lightness
     * @return  Array           The RGB representation
     */
    function HslToRgb(h, s, l) {
        var r, g, b;

        if (s === 0) {
            r = g = b = l; // achromatic
        } else {
            function HueToRgb(p, q, t) {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1 / 6) return p + (q - p) * 6 * t;
                if (t < 1 / 2) return q;
                if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                return p;
            }

            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            var p = 2 * l - q;

            r = HueToRgb(p, q, h + 1 / 3);
            g = HueToRgb(p, q, h);
            b = HueToRgb(p, q, h - 1 / 3);
        }

        return [r * 255, g * 255, b * 255];
    }

    /**
     * Converts an RGB color value to HSV. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSV_color_space.
     * Assumes r, g, and b are contained in the set [0, 255] and
     * returns h, s, and v in the set [0, 1].
     *
     * @param   Number  r       The red color value
     * @param   Number  g       The green color value
     * @param   Number  b       The blue color value
     * @return  Array           The HSV representation
     */
    function rgbToHsv(r, g, b) {
        r /= 255, g /= 255, b /= 255;

        var max = Math.max(r, g, b), min = Math.min(r, g, b);
        var h, s, v = max;

        var d = max - min;
        s = max === 0 ? 0 : d / max;

        if (max === min) {
            h = 0; // achromatic
        } else {
            switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
            }

            h /= 6;
        }

        return [h, s, v];
    }

    /**
     * Converts an HSV color value to RGB. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSV_color_space.
     * Assumes h, s, and v are contained in the set [0, 1] and
     * returns r, g, and b in the set [0, 255].
     *
     * @param   Number  h       The hue
     * @param   Number  s       The saturation
     * @param   Number  v       The value
     * @return  Array           The RGB representation
     */
    function hsvToRgb(h, s, v) {
        var r, g, b;

        var i = Math.floor(h * 6);
        var f = h * 6 - i;
        var p = v * (1 - s);
        var q = v * (1 - f * s);
        var t = v * (1 - (1 - f) * s);

        switch (i % 6) {
        case 0:
            r = v, g = t, b = p;
            break;
        case 1:
            r = q, g = v, b = p;
            break;
        case 2:
            r = p, g = v, b = t;
            break;
        case 3:
            r = p, g = q, b = v;
            break;
        case 4:
            r = t, g = p, b = v;
            break;
        case 5:
            r = v, g = p, b = q;
            break;
        }

        return [r * 255, g * 255, b * 255];
    }

    return {
        rgbToHsl: rgbToHsl,
        HslToRgb: HslToRgb,
        rgbToHsv: rgbToHsv,
        hsvToRgb: hsvToRgb
    }

}());


var svgBuild = (function () {

    var debugPane,
        interfaceHandlers = {},
        idIndex = 0,
        $d3,
        menu,
        stateEnum = {
            drawingMode: "drawingMode",
            currentDrawing: "~currentDrawing",
            defaults: "defaults"
        };


    function getPositionSize(element) {
        var rootPos = element.farthestViewportElement.getBoundingClientRect();
        var pos = element.getBoundingClientRect();
        return {
            y: pos.top - rootPos.top,
            x: pos.left - rootPos.left,
            width: pos.width,
            height: pos.height
        };
    }
    function getUniqueId() {
        var id = "00000" + idIndex++;
        id = "id_" + id.substr(id.length - 5);
        return id;
    }

    function getId(el) {
        var id = el.attr("id");
        if (id == null) {
            id = getUniqueId();
            el.attr("id", id);
        }
        return id;
    }

    function forEachIn(obj, fn) {
        var index = 0;
        for (var key in obj) {
            if (obj.hasOwnProperty(key)) {
                fn(obj[key], key, index++);
            }
        }
    }

    function createElement(type, attr) {
        var element = $d3.select(document.createElementNS($d3.ns.prefix.svg, type));
        if (attr) {
            applyAttr(element, attr);
        }
        return element;
    }

    function fixNull(value, valueIfNull) {
        return typeof value == "undefined" ? typeof valueIfNull == "undefined" ? "" : valueIfNull : value;
    }

    var dataHandler = (function () {
        var db = null;

        function init() {
            if (db == null) {
                db = new Dexie("drawingData,drawing,data");
                db.version(1)
                    .stores({
                        drawings: '&name,data',
                        states: '&state'
                    });
            }
        }

        function save(name, drawing, data) {
            db.drawings.put({ name: name, drawing, data: data });
        }

        function load(name, onLoad) {
            db.drawings.get(name, onLoad);
        }

        function loadState(state, onLoad) {
            db.states.get(state, onLoad);
        }

        function saveState(state, data) {
            db.states.put({ state: state, value: data });
        }

        function deleteDrawing(name) {
            db.drawings.delete(name);
        }

        return {
            init: init,
            load: load,
            save: save,
            loadState: loadState,
            saveState: saveState,
            deleteDrawing: deleteDrawing
        };
    }());

    function copyProperties(obj) {
        var result = {};
        for (var i = 1; i < arguments.length; i++) {
            result[arguments[i]] = obj[arguments[i]];
        }
        return result;
    }

    function buildViewBox(element, settings) {
        element.attr("viewBox", settings.x + " " + settings.y + " " + settings.width + " " + settings.height);
    }

    function transform(element, x, y, scale) {
        element.attr("transform",
            "translate(" + x + "," + y + ")" + (typeof scale !== "undefined" ? " scale(" + scale + ")" : ""));
    }

    function round(number, digits) {
        var f = Math.pow(10, digits);
        return Math.round(f * number) / f;
    }

    function applyAttr(el, props) {
        forEachIn(props,
            function (value, attr) {
                if (attr === "style") {
                    applyStyle(el, value);
                } else {
                    el.attr(attr, value);
                }
            });
        return el;
    }

    function applyStyle(el, styles) {
        forEachIn(styles,
            function (value, attr) {
                el.style(attr, value);
            });
        return el;
    }

    function buildTranslate(el, setting) {
        el.attr("transform", "translate(" + setting.x + "," + setting.y + ")");
    }

    var corelKeyMap = {
        states: {
            multiSelect: "shift",
            subSelectInGroup: "ctrl",
            constrain: "ctrl"
        },
        actions: {
            ungroup: "pick.hasGroupSelected.ctrl.u",
            group: "pick.hasMultipleSelected.ctrl.g",
            save: "ctrl.s",
            alignToPage: "pick.hasSelection.p",
            deleteSelection: "pick.hasSelection.delete"
        }
    };

    var actionMapper = (function () {

        var actions = {};

        function registerActions(newActions) {
            forEachIn(newActions,
                function (action, key) {
                    actions[key] = action;
                });
        }

        function action(actionKey, onComplete) {
            actions[actionKey](onComplete);
        }

        return {
            registerActions: registerActions,
            exec: action
        }
    }());

    var drawingPane = (function () {

        var svgPanel,
            drawingPane,
            statusElement,
            topRuler,
            leftRuler,
            config = {
                maxSize: {
                    height: 30000,
                    width: 40000
                },
                rulerColor: "#9999FF",
                zoomSettings: [
                    0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.25, 1.5, 1.75,
                    2, 2.5, 3, 3.5, 4, 5, 6, 7, 8, 10, 12, 16
                ]
            },
            uiState = { zoom: null },
            drawingProperties = {
                width: 1200,
                height: 1000,
                units: "px"
            }

        function saveCurrentDrawing() {
            dataHandler.save("~currentDrawing", uiState.drawing.node().innerHTML, "yadda");
        }

        function applyZoom(newZoom) {

            if (newZoom !== uiState.zoom) {

                if (typeof newZoom === "string") {

                    if (newZoom.substr(0, 1) === "_") {
                        var pad = 30,
                            objectSize = newZoom === "_toPage" ? drawingProperties : uiState.drawing.node().getBBox();

                        if (objectSize.width === 0 || objectSize.height === 0) {
                            objectSize = drawingProperties;
                        }

                        var scaleX = (uiState.containerSize.width) / (pad + objectSize.width),
                            scaleY = (uiState.containerSize.height) / (pad + objectSize.height);

                        switch (newZoom) {
                            case "_toWidth":
                                uiState.zoom = scaleX;
                                break;
                            case "_toHeight":
                                uiState.zoom = scaleY;
                                break;
                            case "_toPage":
                                uiState.zoom = Math.min(scaleX, scaleY);
                                break;
                        }
                        uiState.zoom = round(Math.min(uiState.zoom, 16), 2);
                        uiState.scroll = { x: 0.5, y: 0.5 };
                        interfaceHandlers.zoom(uiState.zoom);
                        interfaceHandlers.scroll(uiState.scroll);

                    } else {
                        uiState.zoom = Number(newZoom);
                    }
                } else {
                    uiState.zoom = newZoom;
                }

                var increments;

                if (uiState.zoom >= 4) {
                    increments = [10, 5, 1];
                } else if (uiState.zoom > 1.5) {
                    increments = [20, 10, 5];
                } else if (uiState.zoom >= .6) {
                    increments = [100, 50, 10];
                } else if (uiState.zoom >= .4) {
                    increments = [100, 50];
                } else if (uiState.zoom >= 0.2) {
                    increments = [200, 100, 50];
                } else {
                    increments = [500, 100];
                }

                if (uiState.topRuler) {
                    uiState.topRuler.remove();
                }
                if (uiState.leftRuler) {
                    uiState.leftRuler.remove()
                }

                uiState.topRuler = buildRuler(topRuler, increments, false);
                uiState.leftRuler = buildRuler(leftRuler, increments, true);

                applyScrollAndZoom();

            }
        }

        function buildRuler(rulerElement, increments, rotate) {

            var rulerElements = [],
                widthAttr = rotate ? "height" : "width",
                rightAttr = rotate ? "bottom" : "right",
                leftAttr = rotate ? "top" : "left",
                heightAttr = rotate ? "width" : "height",
                x = rotate ? "y" : "x",
                y = rotate ? "x" : "y",
                x1 = x + "1",
                x2 = x + "2",
                y1 = y + "1",
                y2 = y + "2",
                offset,
                rulerContainerSize = rulerElement.node().getBoundingClientRect(),
                rulerHeight = rulerContainerSize[heightAttr],
                majorLineLength = rulerHeight / 2.5,
                rulerDiv = rulerElement.append("div"),
                ruler = rulerDiv.append("svg"),
                pixelStart = -uiState.zeroPoint[x],
                pixelEnd = config.maxSize[widthAttr] - uiState.zeroPoint[x],
                start = Math.floor(pixelStart / increments[0]) * increments[0],
                end = Math.floor(pixelEnd / increments[0]) * increments[0],
                rulerGroup = ruler.append("g"),
                zeroElement;

            var settings = {};
            settings[x] = uiState.zeroPoint[x] * uiState.zoom;
            settings[y] = 0;
            buildTranslate(rulerGroup, settings);

            rulerGroup.append("line")
                .attr("stroke", config.rulerColor)
                .attr(y1, rulerHeight)
                .attr(y2, rulerHeight)
                .attr(x1, pixelStart * uiState.zoom)
                .attr(x2, pixelEnd * uiState.zoom);

            var box = { x: 0, y: 0 };
            box[widthAttr] = config.maxSize[widthAttr] * uiState.zoom;
            box[heightAttr] = 20;
            buildViewBox(ruler, box);

            addTicksAndSubTicks(rulerGroup, start, end, 0);

            rulerElements.push({
                start: start,
                end: end,
                element: rulerGroup
            });
            rulerElements.sort(function (a, b) {
                return a.start < b.start ? -1 : 1;
            });

            function setPosition() {

                var rulerPixelWidth = config.maxSize[widthAttr] * uiState.zoom;
                var scrollDistance = rulerPixelWidth - uiState.containerSize[widthAttr];

                offset = scrollDistance * uiState.scroll[x];

                rulerDiv.style(widthAttr, rulerPixelWidth + "px")
                    .style(leftAttr, -offset + "px");

                var zeroPosition = zeroElement.node().getBoundingClientRect();

                return -(zeroPosition[rightAttr] - rulerContainerSize[leftAttr]);
            }

            function addTicksAndSubTicks(rulerGroup, startPoint, endPoint, incrementIndex) {
                var increment = increments[incrementIndex];
                var lineLength = majorLineLength - incrementIndex * 2;
                var count = Math.abs(startPoint - endPoint) / increment;

                for (var k = 0; k < count; k++) {
                    var distance = increment * k;
                    var textPosition = startPoint + distance;
                    var pixelPosition = textPosition * uiState.zoom;

                    addTick(rulerGroup,
                        pixelPosition,
                        lineLength,
                        incrementIndex === 0 ? textPosition : null);

                    if (incrementIndex < increments.length - 1) {
                        addTicksAndSubTicks(rulerGroup, textPosition, textPosition + increment, incrementIndex + 1);
                    }
                }
            }

            function addTick(rulerGroup, pos, lineLength, text) {
                var line = rulerGroup.append("line")
                    .attr(x1, pos)
                    .attr(y1, rulerHeight - lineLength)
                    .attr(x2, pos)
                    .attr(y2, rulerHeight - 1)
                    .attr("stroke", config.rulerColor)
                    .style("stroke-width", 1);

                if (text === 0) {
                    zeroElement = line;
                }

                if (text !== null) {
                    var textElement = rulerGroup.append("text")
                        .attr("font-size", "8px")
                        .attr(x, pos - (text < 0 ? 2 : 0))
                        .attr(y, 9)
                        .style("fill", config.rulerColor)
                        .text(text)
                        .style("text-anchor", "middle");

                    if (rotate) {
                        textElement.attr("transform", "rotate(-90 10 " + pos + ")");
                    }
                }
            }

            return {
                setPosition: setPosition,
                remove: function () {
                    rulerDiv.remove();
                }
            };
        }

        function applyScrollAndZoom(newScroll) {

            if (newScroll) {
                uiState.scroll = newScroll;
            }

            uiState.xOffset = uiState.topRuler.setPosition();
            uiState.yOffset = uiState.leftRuler.setPosition();

            uiState.scaleLayer.attr("transform", "scale(" + uiState.zoom + ")");

            var box = {
                x: 0,
                y: 0,
                width: uiState.containerSize.width,
                height: uiState.containerSize.height
            };

            box.x = uiState.xOffset;
            box.y = uiState.yOffset;

            uiState.pageBorder.attr("stroke-width", 1 / uiState.zoom);
            uiState.pageBorderShadow.attr("x", 5 / uiState.zoom).attr("y", 5 / uiState.zoom);

            buildViewBox(svgPanel, box);
            applyAttr(uiState.clipPath, box);

        }

        function recalcInterface() {
            uiState.containerSize = drawingPane.node().getBoundingClientRect();

            uiState.zeroPoint = {
                x: (config.maxSize.width - drawingProperties.width) / 2,
                y: (config.maxSize.height - drawingProperties.height) / 2
            }

            uiState.maxBorder = uiState.scaleLayer.append("rect")
                .attr("width", config.maxSize.width)
                .attr("height", config.maxSize.height)
                .attr("x", -uiState.zeroPoint.x)
                .attr("y", -uiState.zeroPoint.y)
                .attr("fill", "none")
                .attr("stroke", "pink");

            svgPanel.attr("width", uiState.containerSize.width)
                .attr("height", uiState.containerSize.height);

            uiState.clipPath.attr("width", uiState.containerSize.width)
                .attr("height", uiState.containerSize.height);

            uiState.pageBorderShadow.attr("x", 5)
                .attr("y", 5)
                .attr("width", drawingProperties.width)
                .attr("height", drawingProperties.height);

            uiState.pageBorder.attr("x", 0)
                .attr("y", 0)
                .attr("width", drawingProperties.width)
                .attr("height", drawingProperties.height);
        }

        var selector = (function () {

            var pad = 5,
                handleSize = 10,
                count = 0,
                displayAttr = { fill: "#777777" },
                activeAttr = { fill: "#77FF77" },
                scaleHandles,
                rotationHandles,
                groupCount = 0,
                rotateMode = false,
                selectedElements = {},
                selectionOrder = [],
                selectedGroups = {},
                rotationHandle =
                    '<rect x="2" y="2" width="7" height="7" fill="white" style="fill-opacity: 0.01"/><path d="m0.29 11.35-0.28513-4.0005h0.0285v0.0285l0.0285 0.0285 0.0285 ' +
                        '0.0285h0.0285v0.0285h0.0285v0.0285l0.0285 0.0285 0.0285 0.0285 0.0285 0.0285h0.0285v0.0285h0.0285l0.0285 ' +
                        '0.0285 0.0285 0.0285h0.0285v0.0285h0.0285v0.0285h0.0285l0.0285 0.0285h0.0285v0.0285h0.0285l0.0285 ' +
                        '0.0285h0.0285v0.0285h0.0285l0.0285 0.0285h0.0285l0.0285 0.0285h0.0285 0.0285v0.0285h0.0285l0.0285 0.0285h0.0285 ' +
                        '0.0285l0.0285 0.0285h0.0285l0.0285 0.0285h0.0285 0.0285 0.0285v0.0285h0.0285 0.0285 0.0285 0.0285l0.0285 ' +
                        '0.0285h0.0285 0.0285 0.0285 0.0285 0.0285l0.0285 0.0285h0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 ' +
                        '0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285v-0.0285h0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 ' +
                        '0.0285v-0.0285h0.0285 0.0285 0.0285 0.0285l0.0285-0.0285h0.0285 0.0285 0.0285v-0.0285h0.0285 0.0285 ' +
                        '0.0285l0.0285-0.0285h0.0285 0.0285l0.0285-0.0285-2.082 3.429z" fill-rule="evenodd"/>' +
                        '<path d="m7.33 0.92-0.17117 0.057-0.14264 0.0285-0.14264 0.057-0.17118 0.057-0.14264 0.0285-0.14264 0.057-0.14264 ' +
                        '0.057-0.14265 0.0856-0.14264 0.057-0.14264 0.057-0.14265 0.057-0.14264 0.0856-0.14264 0.057-0.14264 ' +
                        '0.0856-0.14265 0.0856-0.14264 0.057-0.11411 0.0856-0.14265 0.0856-0.14264 0.0856-0.11411 0.0856-0.14264 ' +
                        '0.0856-0.11411 0.0856-0.11412 0.0856-0.14264 0.11412-0.11412 0.0856-0.11411 0.1145-0.11411 0.0856-0.11412 ' +
                        '0.1145-0.11411 0.0856-0.11412 0.11411-0.11411 0.11411-0.11412 0.1145-0.11411 0.11449-0.11411 0.11411-0.0856 ' +
                        '0.1145-0.11411 0.11449-0.0856 0.11412-0.11411 0.11449-0.0856 0.11411-0.0856 0.14303-0.11411 0.11449-0.0856 ' +
                        '0.14265-0.0856 0.11449-0.0856 0.14302-0.0856 0.1145-0.0856 0.14264-0.057 0.14303-0.0856 0.11449-0.0856 0.14302-0.057 ' +
                        '0.14264-0.0856 0.14303-0.057 0.14302-0.0856 0.14302-0.057 0.14303-0.057 0.14264-0.057 0.14302-0.057 0.14302-0.057 ' +
                        '0.14303-0.057 0.17155-0.0285 0.14302-0.057 0.14265-0.057 0.17155-0.0285 0.14302-0.057 0.14302 0.99821 0.25718 ' +
                        '0.0285-0.14265 0.0285-0.14302 0.057-0.14302 0.0285-0.1145 0.057-0.14302 0.0285-0.14265 0.057-0.11449 0.057-0.14302 ' +
                        '0.057-0.14264 0.057-0.1145 0.057-0.14302 0.057-0.11449 0.057-0.14264 0.057-0.1145 0.057-0.11449 0.0856-0.14265 ' +
                        '0.057-0.1145 0.0856-0.11449 0.057-0.11411 0.0856-0.11449 0.057-0.11412 0.0856-0.11411 0.0856-0.1145 0.0856-0.11412 ' +
                        '0.0856-0.11449 0.0856-0.11411 0.0856-0.11449 0.0856-0.0856 0.0856-0.11411 0.0856-0.1145 0.11411-0.0856 0.0856-0.11449 ' +
                        '0.11411-0.0856 0.0856-0.0856 0.11411-0.11412 0.0856-0.0856 0.11411-0.0856 0.0856-0.0856 0.11411-0.0856 0.11412-0.0856 ' +
                        '0.11411-0.0856 0.11412-0.0856 0.11411-0.0856 0.11411-0.0856 0.11411-0.0856 0.11412-0.057 0.11411-0.0856 0.11412-0.057 ' +
                        '0.11411-0.0856 0.14264-0.057 0.11412-0.057 0.11411-0.0856 0.14265-0.057 0.11411-0.057 0.14264-0.057 0.11412-0.057 ' +
                        '0.14264-0.057 0.14264-0.057 0.11412-0.0285 0.14264-0.057 0.14264-0.057 0.11412-0.0285 0.14264-0.0285 0.14264-0.057z"/>' +
                        '<path d="m10.9 0.49-3.9928-0.20008v0.0285h0.0285l0.0285 0.0285 0.0285 0.0285 0.0285 0.0285v0.0285h0.0285l0.0285 ' +
                        '0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285v0.0285h0.0285v0.0285h0.0285v0.0285h0.0285v0.0285l0.0285 ' +
                        '0.0285v0.0285h0.0285v0.0285h0.0285v0.0285l0.0285 0.0285v0.0285h0.0285v0.0285l0.0285 0.0285v0.0285l0.0285 ' +
                        '0.0285v0.0285l0.0285 0.0285v0.0285h0.0285v0.0285 0.0285l0.0285 0.0285v0.0285 0.0285h0.0285v0.0285 0.0285l0.0285 ' +
                        '0.0285v0.0285 0.0285l0.0285 0.0285v0.0285 0.0285 0.0285l0.0285 0.0285v0.0285 0.0285 0.0285 0.0285 0.0285 0.0285l0.0285 ' +
                        '0.0285v0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285 0.0285l-0.0285 ' +
                        '0.0285v0.0285 0.0285 0.0285 0.0285 0.0285 0.0285l-0.0285 0.0285v0.0285 0.0285 0.0285 0.0285h-0.0285v0.0285 0.0285 ' +
                        '0.0285l-0.0285 0.0285v0.0285 0.0285l-0.0285 0.0285v0.0285 0.0285l3.3654-2.1717z" fill-rule="evenodd"/>',
                skewHandle =
                    '<rect x="-1.5" y="0" width="5" height="12" fill="white" style="fill-opacity; 0.01" /><path d="m1.195 0.0045072 1.2264 3.829h-0.028516-0.028516v-0.028516h-0.028516l-0.028516-0.028516-0.028515-0.028516h-' +
                        '0.028516l-0.028516-0.028516h-0.028516l-0.028516-0.028515h-0.028516v-0.028516h-0.028516-0.028516v-0.028516h-0.028515-0.028516l-' +
                        '0.028516-0.028516h-0.028516l-0.028516-0.028516h-0.028516-0.028515l-0.028516-0.028516h-0.028516-0.028516v-0.028516h-0.028515-' +
                        '0.028516-0.028516l-0.028516-0.028516h-0.028516-0.028515-0.028516l-0.028516-0.028515h-0.028516-0.028515-0.028516-0.028516-' +
                        '0.028516l-0.028515-0.028516h-0.028516-0.028516-0.028516-0.028515-0.028516-0.028516-0.028516-0.028515-0.028516-0.028516-' +
                        '0.028516-0.028515-0.028516-0.028516l-0.028516 0.028516h-0.028516-0.028516-0.028516-0.028516-0.028516l-0.028516 0.028515h-' +
                        '0.028516-0.028516-0.028516l-0.028516 0.028516h-0.028516-0.028516-0.028516v0.028516h-0.028516-0.028516l-0.028516 0.028516h-' +
                        '0.028516-0.028516v0.028516h-0.028516-0.028516v0.028516h-0.028516-0.028516l-0.028516 0.028516h-0.028516l-0.028516 0.028516h-' +
                        '0.028516v0.028515h-0.028516-0.028516v0.028516h-0.028516-0.028516v0.028516h-0.028516l-0.028516 0.028516-0.028516 0.028516h-' +
                        '0.028516l1.1978-3.829z" fill-rule="evenodd"/>' +
                        '<path d="m1.7046 7.9743v-4.8273h-1v4.8273z"/>' +
                        '<path d="m1.195 11.124 1.2264-3.829h-0.028516-0.028516v0.028516h-0.028516l-0.028516 0.028516-0.028515 0.028516h-0.028516l-0.028516 ' +
                        '0.028516h-0.028516l-0.028516 0.028516h-0.028516v0.028516h-0.028516-0.028516v0.028516h-0.028515-0.028516l-0.028516 ' +
                        '0.028516h-0.028516l-0.028516 0.028516h-0.028516-0.028515l-0.028516 0.028516h-0.028516-0.028516v0.028516h-0.028515-0.028516-' +
                        '0.028516l-0.028516 0.028516h-0.028516-0.028515-0.028516l-0.028516 0.028515h-0.028516-0.028515-0.028516-0.028516-0.028516l-' +
                        '0.028515 0.028516h-0.028516-0.028516-0.028516-0.028515-0.028516-0.028516-0.028516-0.028515-0.028516-0.028516-0.028516-' +
                        '0.028515-0.028516-0.028516l-0.028516-0.028516h-0.028516-0.028516-0.028516-0.028516-0.028516l-0.028516-0.028515h-0.028516-' +
                        '0.028516-0.028516l-0.028516-0.028516h-0.028516-0.028516-0.028516v-0.028516h-0.028516-0.028516l-0.028516-0.028516h-0.028516-' +
                        '0.028516v-0.028516h-0.028516-0.028516v-0.028516h-0.028516-0.028516l-0.028516-0.028516h-0.028516l-0.028516-0.028516h-0.028516v-' +
                        '0.028516h-0.028516-0.028516v-0.028516h-0.028516-0.028516v-0.028516h-0.028516l-0.028516-0.028516-0.028516-0.028516h-0.028516l1.1978 ' +
                        '3.829z" fill-rule="evenodd"/>',
                scaleHandlesConfig = {
                    x1: { x: "x1", y: "y1", constrain: "proportional" },
                    left: { x: "x1", y: "yMid", constrain: "x" },
                    x2: { x: "x1", y: "y2", constrain: "proportional" },
                    bottom: { x: "xMid", y: "y2", constrain: "y" },
                    y2: { x: "x2", y: "y2", constrain: "proportional" },
                    right: { x: "x2", y: "yMid", constrain: "x" },
                    y1: { x: "x2", y: "y1", constrain: "proportional" },
                    top: { x: "xMid", y: "y1", constrain: "x" }
                },
                rotationHandlesConfig = {
                    x1: { x: "x1", y: "y1", xCor: 0, yCor: 0, handle: rotationHandle, rotate: 0 },
                    left: { x: "x1", y: "yMid", xCor: 0, yCor: -0.6, handle: skewHandle, rotate: 0 },
                    x2: { x: "x1", y: "y2", xCor: 0, yCor: 0, handle: rotationHandle, rotate: -90 },
                    bottom: { x: "xMid", y: "y2", xCor: 0.5, yCor: 0.5, handle: skewHandle, rotate: 90 },
                    y2: { x: "x2", y: "y2", xCor: 0, yCor: 0, handle: rotationHandle, rotate: 180 },
                    right: { x: "x2", y: "yMid", xCor: 0.5, yCor: -0.6, handle: skewHandle, rotate: 0 },
                    y1: { x: "x2", y: "y1", xCor: 0, yCor: 0, handle: rotationHandle, rotate: 90 },
                    top: { x: "xMid", y: "y1", xCor: 0.5, yCor: 0, handle: skewHandle, rotate: 90 }
                };

            function showHandles(show) {
                keyHandler.setContext(count > 1 ? "hasMultipleSelected" : "hasSelection", show);
                keyHandler.setContext("hasGroupSelected", groupCount > 0);
                scaleHandles.layer.attr("visibility", show && !rotateMode ? "visible" : "hidden");
                rotationHandles.layer.attr("visibility", show && rotateMode ? "visible" : "hidden");
            }

            function drawHandles() {
                if (count < 1) {
                    clear();
                    return;
                }

                var sb = {};

                forEachIn(selectedElements,
                    function (element, id, index) {
                        var bBox = element.node().getBBox();
                        var x1 = bBox.x,
                            y1 = bBox.y,
                            x2 = x1 + bBox.width,
                            y2 = y1 + bBox.height;

                        if (index === 0) {
                            sb = { x1: x1, y1: y1, x2: x2, y2: y2 }
                        } else {
                            sb.x1 = Math.min(sb.x1, x1);
                            sb.x2 = Math.max(sb.x2, x2);
                            sb.y1 = Math.min(sb.y1, y1);
                            sb.y2 = Math.max(sb.y2, y2);
                        }
                    });

                var w = handleSize / uiState.zoom,
                    p = pad / uiState.zoom;

                sb.xMid = (sb.x2 + sb.x1 - w) / 2;
                sb.yMid = (sb.y2 + sb.y1 - w) / 2;
                sb.x1 += -(p + w);
                sb.y1 += -(p + w);
                sb.x2 += p;
                sb.y2 += p;

                if (rotateMode) {

                    var scale = 2 / uiState.zoom,
                        ro = handleSize / 2 / uiState.zoom;

                    forEachIn(rotationHandlesConfig,
                        function (handle, key) {
                            applyAttr(rotationHandles[key],
                            {
                                transform: "translate(" +
                                    (sb[handle.x] + handle.xCor * w) +
                                    "," +
                                    (sb[handle.y] + handle.yCor * w) +
                                    ") " +
                                    (handle.rotate === 0 ? "" : "rotate(" + handle.rotate + "," + ro + "," + ro + ")") +
                                    "scale(" +
                                    scale +
                                    ")"
                            });
                        });
                } else {
                    forEachIn(scaleHandlesConfig,
                        function (handle, key) {
                            applyAttr(scaleHandles[key], { width: w, height: w, x: sb[handle.x], y: sb[handle.y] });
                        });
                }
            }

            function applyHandleActions(handle, nodeType, action) {
                handle.on("click",
                    function () {
                        alert(action + " here");
                    });
                handle.on("mouseover",
                    function () {
                        applyAttr($d3.select(this), activeAttr);
                    });
                handle.on("mouseout",
                    function () {
                        applyAttr($d3.select(this), displayAttr);
                    });
            }

            function setFill(color) {
                alert('was here to fill ' + color);
            }

            function init() {
                var scaleGroup = applyAttr(uiState.scaleLayer.append("g"), { visibility: "hidden" });

                scaleHandles = { layer: scaleGroup };
                forEachIn(scaleHandlesConfig,
                    function (handle, key) {
                        scaleHandles[key] = applyAttr(scaleGroup.append("rect"), displayAttr);
                        applyHandleActions(scaleHandles[key], key, "scale");
                    });

                var rotationGroup = applyAttr(uiState.scaleLayer.append("g"), { visibility: "hidden" });
                rotationHandles = { layer: rotationGroup };
                forEachIn(rotationHandlesConfig,
                    function (handle, key) {
                        rotationHandles[key] = applyAttr(rotationGroup.append("g"), displayAttr);
                        rotationHandles[key].node().innerHTML = handle.handle;
                        applyHandleActions(rotationHandles[key], key, "rotate");
                    });

                svgBuild.registerInterfaceHandler("fill", setFill)
            }

            function start() {
                uiState.drawing.selectAll("*")
                    .on("click",
                        function () {
                            $d3.event.stopPropagation();
                            toggleSelection($d3.select(this));
                        });
                svgPanel.on("click",
                    function () {
                        clear();
                    });
            }

            function stop() {
                clear();
                showHandles(false);
                svgPanel.on("click", null);
                uiState.drawing.selectAll("*").on("click", null);
            }

            function addSelectedGroupItems(groupNode, groupId) {
                forEachIn(getGroupChildren(groupNode),
                    function (nodeElement, nodeId) {
                        selectedGroups[groupId].children.push(nodeId);
                        selectedElements[nodeId] = nodeElement;
                        selectionOrder.push(nodeId);
                    });
            }

            function getGroupChildren(groupNode, list) {

                if (!list) {
                    list = {};
                };

                forEachIn(groupNode.children,
                    function (node) {
                        if (node.localName === "g") {
                            getGroupChildren(node, list);
                        } else {
                            list[getId($d3.select(node))] = $d3.select(node);
                        }
                    });

                return list;
            }

            function removeSelectedGroupItems(groupId) {
                var group = selectedGroups[groupId];
                group.children.forEach(function (childId) {
                    delete selectedElements[childId];
                });
                delete selectedGroups[groupId];
                groupCount--;
            }

            function getElementInfo(el) {
                var id = getId(el);
                var groupNode = el.node();
                var groupId;
                var isGroup = false;

                do {
                    var parentNode = groupNode.parentNode;
                    groupId = getId($d3.select(parentNode));
                    if (groupId !== "id_drawing") {
                        groupNode = parentNode;
                    }
                } while (groupId !== "id_drawing")

                var groupElement = $d3.select(groupNode);
                var parentId = getId(groupElement);

                if (parentId !== id) {
                    id = parentId;
                    isGroup = true;
                }
                return {
                    isGroup: isGroup,
                    id: id,
                    groupElement: isGroup ? groupElement : null,
                    groupNode: isGroup ? groupNode : null
                };
            }

            function toggleSelection(el) {

                var add = false;
                var elementInfo = getElementInfo(el);

                var multiSelect = keyHandler.getState("multiSelect");
                var subSelectInGroup = keyHandler.getState("subSelectInGroup");

                var alreadySelected = elementInfo.isGroup
                    ? typeof selectedGroups[elementInfo.id] != "undefined"
                    : typeof selectedElements[elementInfo.id] !== "undefined";

                if (subSelectInGroup) {
                    var yadda = "nadda";
                } else {
                    if (multiSelect) {
                        if (alreadySelected) {
                            if (elementInfo.isGroup) {
                                removeSelectedGroupItems(elementInfo.id);
                            } else {
                                delete selectedElements[elementInfo.id];
                            }
                            count--;

                        } else {
                            add = true;
                        }
                    } else {
                        if (alreadySelected && count === 1) {
                            rotateMode = !rotateMode;
                        } else {
                            clear();
                            add = true;
                        }
                    }
                }

                if (add) {
                    if (elementInfo.isGroup) {
                        groupCount++;
                        selectedGroups[elementInfo.id] = { element: elementInfo.groupElement, children: [] }
                        addSelectedGroupItems(elementInfo.groupNode, elementInfo.id);
                    } else {
                        selectedElements[elementInfo.id] = el;
                        selectionOrder.push(elementInfo.id);
                    }
                    count++;
                }

                drawHandles();
                showHandles(true);
            }

            function clear() {
                selectedElements = {};
                selectedGroups = {};
                selectionOrder = [];
                groupCount = 0;
                count = 0;
                rotateMode = false;
                showHandles(false);
            }

            function deleteSelection() {
                forEachIn(selectedElements,
                    function (element) {
                        element.remove();
                    });
                saveCurrentDrawing();
                clear();
            };

            function group() {
                var groupElement = uiState.drawing.append("g");
                getId(groupElement);
                var content = [];
                var elementId = null;
                var handledElements = {};
                forEachIn(selectedElements, function (element, id) {
                    if (!handledElements[id]) {
                        var groupInfo = getElementInfo(element);
                        if (groupInfo.isGroup) {
                            forEachIn(getGroupChildren(groupInfo.groupNode),
                                function (childElement, childId) {
                                    handledElements[childId] = true;
                                });
                            element = groupInfo.groupElement;
                        }
                        content.push(element.node().outerHTML);
                        if (elementId === null) {
                            elementId = id;
                        }
                        element.remove();
                    }
                });
                groupElement.node().innerHTML = content.join("");
                stop();
                start();
                saveCurrentDrawing();
                toggleSelection(groupElement);
            }

            function unGroup() {
                var handledElements = {};
                var elementsToSelect = [];
                selectionOrder.forEach(function (id) {
                    var element = selectedElements[id];
                    if (!handledElements[id]) {
                        var elemInfo = getElementInfo(element);
                        if (elemInfo.isGroup) {
                            forEachIn(getGroupChildren(elemInfo.groupNode),
                                function (childElement, childId) {
                                    handledElements[childId] = true;
                                    elementsToSelect.push(childId);
                                });
                            elemInfo.groupNode.outerHTML = elemInfo.groupNode.innerHTML;
                        } else {
                            elementsToSelect.push(elemInfo.id);
                        }
                    }
                });
                stop();
                start();
                saveCurrentDrawing();
                elementsToSelect.forEach(function (id) {
                    toggleSelection(uiState.drawing.select("#" + id));
                });
            }
            
            return {
                toggleSelection: toggleSelection,
                clear: clear,
                start: start,
                stop: stop,
                init: init,
                group: group,
                unGroup: unGroup,
                deleteSelection: deleteSelection,
                refresh: drawHandles
            }

        }());

        function drawingPaneInit() {

            keyHandler.init(corelKeyMap, actionMapper.exec);

            actionMapper.registerActions({
                save: function (done) {
                    alert("save");
                    done();
                },
                alignToPage: function (done) {
                    alert("alignToPage");
                    done();
                },
                deleteSelection: function (done) {
                    selector.deleteSelection();
                    done();
                },
                ungroup: function (done) {
                    selector.unGroup();
                    done();
                },
                group: function (done) {
                    selector.group();
                    done();
                }
            });

            window.onresize = function () {
                recalcInterface();
                applyScrollAndZoom();
            }

            var clipId = "drawingClip",
            menuDiv = $d3.select("#menuDiv"),
            mouseIsOverPanel;

            drawingPane = $d3.select("#drawingPane");
            topRuler = $d3.select("#topRuler");
            leftRuler = $d3.select("#leftRuler");
            svgPanel = drawingPane.append("svg");

            uiState.clipPath = svgPanel.append("defs")
                .append("svg:clipPath")
                .attr("id", clipId)
                .append("svg:rect");

            uiState.drawingClipGroup = svgPanel.append("g")
                .attr("clip-path", "url(#" + clipId + ")");

            uiState.scaleLayer = uiState.drawingClipGroup.append("g");

            var pageBorderGroup = uiState.scaleLayer.append("g");
            uiState.pageBorderShadow = pageBorderGroup.append("rect")
                .style("fill", "#888888");

            uiState.pageBorder = pageBorderGroup.append("rect")
                .attr("stroke", "#888888")
                .attr("stroke-width", 1)
                .style("fill", "white");

            uiState.drawing = applyAttr(uiState.scaleLayer.append("g"), { id: "id_drawing" });
            uiState.interface = uiState.scaleLayer.append("g");

            statusElement = getElement("status");
            recalcInterface();

            $d3.select('body')
                .on("mousemove",
                    function () {
                        var isMousedOver = $d3.mouse(this)[0] > uiState.containerSize.left;
                        if (isMousedOver !== mouseIsOverPanel) {
                            mouseIsOverPanel = isMousedOver;
                            menuDiv.style("z-index", isMousedOver ? 1 : 10);
                            drawingPane.style("z-index", isMousedOver ? 10 : 1);
                        }
                    });

            applyZoom("_toPage");

            var drawingIds = {};
            function assignUniqueIds(node) {
                var element = $d3.select(node);
                var id = element.attr("id");
                if (id == null || drawingIds[id] || id.indexOf("~") > -1) {
                    id = getUniqueId();
                    element.attr("id", id);
                }
                forEachIn(node.children, assignUniqueIds);
                drawingIds[id] = true;
            }

            function loadDrawing(svg) {
                var drawingNode = uiState.drawing.node();
                drawingNode.innerHTML = svg;
                drawingIds = {};
                assignUniqueIds(drawingNode);

                initCurrentHandler();
            }

            dataHandler.loadState(stateEnum.currentDrawing,
                function (result) {
                    uiState.currentDrawing = fixNull(result, "~currentDrawing");
                    dataHandler.load(uiState.currentDrawing,
                        function (result) {
                            if (result != null) {
                                loadDrawing(result.drawing);
                            }
                        });
                });


            dataHandler.loadState(stateEnum.defaults,
                function (result) {
                    uiState.defaults = fixNull(result,
                    {
                        fill: "none",
                        strokeWidth: 1
                    });
                });

            selector.init();
        }

        function dragger(element, onDrag, unSelect, create) {

            var startPosition = null,
                currentElement = element,
                width,
                height;

            function getPosition(pos) {
                return {
                    x: (pos.x + uiState.xOffset) / uiState.zoom,
                    y: (pos.y + uiState.yOffset) / uiState.zoom
                };
            }

            function drag() {
                var pos = getPosition($d3.event);
                width = pos.x - startPosition.x;
                height = pos.y - startPosition.y;

                if (keyHandler.getState("constrain")) {
                    var m = Math.min(width, height);
                    width = m;
                    height = m;
                };

                if (width !== 0 || height !== 0) {
                    if (currentElement === null) {
                        currentElement = create(pos, width, height);
                    }

                    var attr = {
                        x: startPosition.x + (width > 0 ? 0 : width),
                        y: startPosition.y + (height > 0 ? 0 : height),
                        width: Math.abs(width),
                        height: Math.abs(height)
                    }
                    onDrag(currentElement, attr);
                }
            }

            function dragEnd() {
                if (unSelect) {
                    currentElement = null;
                }
                saveCurrentDrawing();
                startPosition = null;
            }

            function dragStart() {
                if (startPosition == null) {
                    startPosition = getPosition($d3.event);
                    width = 0;
                    height = 0;

                    currentElement = create();
                }
            }

            svgPanel.call($d3.drag().on("start", dragStart).on("drag", drag).on("end", dragEnd));

            return {
                close: function () {
                    svgPanel.call($d3.drag().on("start", null).on("drag", null).on("end", null));
                }

            }
        }

        var circleHandler = (function () {

            var dragHandler;

            function draw(currentElement, attr) {
                var props = {
                    cx: attr.x + attr.width / 2,
                    cy: attr.y + attr.height / 2,
                    rx: attr.width / 2,
                    ry: attr.height / 2
                };
                applyAttr(currentElement, props);
            }

            function init() {
                dragHandler = dragger(null, draw, true, function () {
                    return uiState.drawing.append("ellipse")
                        .style("opacity", 0.5)
                        .attr("stroke", "black")
                        .attr("fill", "#FAFAFA");
                });
            };

            function close() {
                dragHandler.close();
            }

            function refresh() {

            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };

        }());

        var lineHandler = (function () {

            function init() {

            }

            function close() {

            }

            function refresh() {

            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };
        }());

        var nodeHandler = (function () {

            function init() {

            }

            function close() {

            }
            function refresh() {

            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };
        }());

        var pickHandler = (function () {

            function init() {
                selector.start();
            }

            function close() {
                selector.stop();
            }

            function refresh() {
                selector.refresh();
            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };

        }());

        var rectangleHandler = (function () {

            var dragHandler;

            function init() {
                dragHandler = dragger(null, applyAttr, true, function () {
                    return uiState.drawing.append("rect")
                        .style("opacity", 0.5)
                        .attr("stroke", "black")
                        .attr("fill", "#FAFAFA");
                });
            };

            function close() {
                dragHandler.close();
            }

            function refresh() {
            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };

        }());

        var zoomHandler = (function () {

            function init() {

            }

            function close() {

            }

            function refresh() {

            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };

        }());

        var polygonHandler = (function () {

            function init() {

            }

            function close() {

            }

            function refresh() {

            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };

        }());


        var textHandler = (function () {

            function init() {

            }

            function close() {

            }

            function refresh() {

            }

            return {
                init: init,
                close: close,
                refresh: refresh
            };
        }());

        var currentHandler = null,

            drawingModes = {
                circle: { name: "Circle / Ellipse Tool", handler: circleHandler, contexts: "" },
                line: { name: "Line Tool", handler: lineHandler, contexts: "" },
                node: { name: "Node Tool", handler: nodeHandler, contexts: "" },
                pick: { name: "Pick Tool", handler: pickHandler, contexts: "hasSelection.singleSelection.multiSelection.hasGroupSelected.hasMultipleSelected" },
                polygon: { name: "Polygon Tool", handler: polygonHandler, contexts: "" },
                rectangle: { name: "Rectangle Tool", handler: rectangleHandler, contexts: "" },
                zoom: { name: "Zoom Tool", handler: zoomHandler, contexts: "" },
                text: { name: "Text Tool", handler: textHandler, contexts: "" }
            };

        function setDrawingMode(mode) {
            if (currentHandler !== null) {
                currentHandler.close();
            }
            dataHandler.saveState(stateEnum.drawingMode, mode);
            drawingPane.node().className = "drawingPane " + mode;
            keyHandler.setContextModes("+" + mode + "." + drawingModes[mode].contexts);
            currentHandler = drawingModes[mode].handler;
            currentHandler.init();
        }

        function refreshCurrentHandler() {
            if (currentHandler !== null) {
                currentHandler.refresh();
            }
        }

        function initCurrentHandler() {
            if (currentHandler !== null) {
                currentHandler.init();
            }
        }

        function setStatus(message) {
            statusElement.innerText = message;
        }

        function getModeName(id) {
            try {
                return drawingModes[id].name;
            } catch (e) {
                return "error";
            }
        }

        return {
            setDrawingMode: setDrawingMode,
            getModeName: getModeName,
            init: drawingPaneInit,
            getConfig: function () {
                return config;
            },
            zoom: function (newZoom) {
                if (newZoom) {
                    applyZoom(newZoom);
                    refreshCurrentHandler();
                }
                return uiState.zoom;
            },
            scroll: function (newScroll) {
                if (newScroll) {
                    applyScrollAndZoom(newScroll);
                }
                return uiState.scroll;
            }
        }
    }());

    function getElement(id) {
        return document.getElementById(id);
    }

    // Function to download data to a file
    // http://stackoverflow.com/questions/13405129/javascript-create-and-save-file
    function download(data, filename, type) {
        var a = document.createElement("a"),
            file = new Blob([data], { type: type });
        if (window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveOrOpenBlob(file, filename);
        } else {
            var url = URL.createObjectURL(file);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }
    }

    menu = (function () {
        var hoverColor = "#C7E6B8",
            selectedColor = "#639CFF",
            originalColor = null,
            menuElement,
            parentSvg,
            toolTip = null,
            icons,
            currentSelection,
            currentBackground = null;

        function removeToolTip() {
            if (toolTip != null) {
                toolTip.remove();
                toolTip = null;
            }
        }

        function menuInit() {
            menuElement = $d3.select("#menu");
            icons = menuElement.selectAll("g")
                .on("mouseover",
                    function () {
                        var node = $d3.select(this),
                            id = node.attr("id");

                        if (currentSelection === id) {
                            return;
                        }
                        var background = $d3.select(this.firstElementChild);
                        var pos = getPositionSize(this.firstElementChild);

                        removeToolTip();

                        toolTip = menuElement.append("g");
                        var rectangle = toolTip.append("rect")
                            .attr("height", 20)
                            .attr("x", pos.x + pos.width + 3)
                            .attr("y", pos.y + pos.height / 4)
                            .attr("ry", "3px")
                            .attr("width", 100)
                            .attr("fill", "white")
                            .attr("stroke", "#7c8080")
                            .attr("stroke-width", 1);

                        var text = toolTip.append("text")
                            .text(drawingPane.getModeName(id))
                            .attr("x", pos.x + pos.width + 7)
                            .attr("y", pos.y + pos.height / 4 + 14)
                            .style("font-size", "12px")
                            .style("word-spacing", "-1px");

                        var textPos = text.node().getBBox();
                        rectangle.attr("width", textPos.width + 8);

                        if (originalColor == null) {
                            originalColor = background.attr("fill");
                        }
                        background.attr("fill", hoverColor);
                    });

            icons.on("mouseout",
                function () {
                    var node = $d3.select(this);
                    var id = node.attr("id");
                    if (id !== currentSelection) {
                        $d3.select(this.firstElementChild).attr("fill", originalColor);
                        removeToolTip();
                    }
                });

            icons.on("click",
                function () {
                    removeToolTip();
                    var node = $d3.select(this);
                    var id = node.attr("id");
                    if (currentSelection === id || id === null) {
                        return;
                    }
                    if (currentBackground != null) {
                        currentBackground.attr("fill", originalColor);
                    }
                    setMenuMode(id);
                });

            dataHandler.loadState(stateEnum.drawingMode,
                function (result) {
                    setMenuMode(fixNull(result.value, "pick"));
                });
        }

        function setMenuMode(id) {
            currentSelection = id;
            currentBackground = $d3.select(menuElement.select("#" + id).node().firstElementChild);
            currentBackground.attr("fill", selectedColor);
            drawingPane.setDrawingMode(id);
        }

        return {
            init: menuInit,
            currentMode: function () {
                return currentSelection;
            }
        };
    }());

    function debugMessage(message) {
        document.body.className = "showDebug";
        if (typeof message === "object" && message !== null) {
            var out = {};
            for (var key in message) {
                if (typeof message[key] !== "function") {
                    out[key] = message[key];
                }
            }
            var el = document.createElement("p");
            el.innerText = JSON.stringify(out, null, 1);
            debugPane.appendChild(el);
        } else {
            debugPane.innerText = typeof message === "undefined" ? "undefined" : message === null ? "null" : message.toString();
        }
    }

    function appInit() {
        var maxTries = 20;
        var interval = setInterval(function () {
            debugPane = getElement("debugPane");
            $d3 = d3;
            if (typeof d3 !== "undefined" || typeof debugPane === "undefined") {
                clearInterval(interval);
                var cssPrefix = (function () {
                    var styles = window.getComputedStyle(document.documentElement, ''),
                      pre = (Array.prototype.slice
                        .call(styles)
                        .join('')
                        .match(/-(moz|webkit|ms)-/) || (styles.OLink === '' && ['', 'o'])
                      )[1],
                      dom = ('WebKit|Moz|MS|O').match(new RegExp('(' + pre + ')', 'i'))[1];
                    return {
                        dom: dom,
                        lowercase: pre,
                        css: '-' + pre + '-',
                        js: pre[0].toUpperCase() + pre.substr(1)
                    };
                })();
                document.getElementById("body").className += " " + cssPrefix.lowercase;
                dataHandler.init();
                drawingPane.init();
                menu.init();

            } else {
                maxTries--;
                if (maxTries === 0) {
                    alert("Could not load $d3.js. Check your internet connection.\nIt's possible but not likely that the server is down.");
                    clearInterval(interval);
                }
            }
        }, 100);
    }

    return {
        init: appInit,
        getConfig: drawingPane.getConfig,
        zoom: drawingPane.zoom,
        scroll: drawingPane.scroll,
        registerInterfaceHandler: function (name, handler) {
            interfaceHandlers[name] = handler;
        },
        debugMessage: debugMessage
    };
}());

svgBuild.init();

var svgBuildInterface = angular.module("svgBuildInterface", []);

svgBuildInterface.directive('ngRightClick', function ($parse) {
    return function (scope, element, attrs) {
        var fn = $parse(attrs.ngRightClick);
        element.bind('contextmenu', function (event) {
            scope.$apply(function () {
                event.preventDefault();
                fn(scope, { $event: event });
            });
        });
    };
});

var svgBuildController = angular.module("svgBuildInterface")
    .controller("svgBuildController", ["$rootScope", "$scope", "$timeout", function ($rootScope, $scope, $timeout) {

        $rootScope.utils = {
            applyCss: function (el, attr, value) {
                var css = {};
                css[attr] = value;
                el.css(css);
            },
            getRect: function (el) {
                return el[0].getBoundingClientRect();
            },
            getHex: function toHex(d) {
                return ("0" + (Math.round(d).toString(16))).slice(-2).toUpperCase();
            },
            getLoc: function () {
                return ((navigator.languages && navigator.languages.length)
                    ? navigator.languages[0]
                    : navigator.language).split("-")[0].toUpperCase();
            }
        };

        var zoomArray = svgBuild.getConfig().zoomSettings.join(",").split(",");

        function formatZoom(zoom) {
            if (zoom != null) {
                $scope.zoom.hideZoom = false;
                $scope.zoom.zoom = zoom.toString();
                $scope.zoom.zoomText = zoomArray.indexOf(zoom) < 0 ? Math.round($scope.zoom.zoom * 100) + "%" : "";
            } else {
                $scope.zoom.hideZoom = false;
            }
        }

        angular.extend($scope, {
            zoom: {
                zooms: [{
                    id: "_toPage",
                    name: "to Page"
                }, {
                    id: "_toWidth",
                    name: "to Width"
                }, {
                    id: "_toHeight",
                    name: "to Height"
                }],
                zoom: "",
                hideZoom: false
            },
            scroll: {
                x: 0.5,
                y: 0.5
            }
        });

        for (var i = 0; i < zoomArray.length; i++) {
            $scope.zoom.zooms.push({ id: zoomArray[i], name: zoomArray[i] * 100 + "%" });
        }

        formatZoom(svgBuild.zoom());

        $scope.zoom.zoomText = "";

        svgBuild.registerInterfaceHandler("zoom",
              function (zoom) {
                  formatZoom(zoom);
                  $scope.$broadcast("newZoom", $scope.zoom);
              });

        svgBuild.registerInterfaceHandler("scroll",
            function(newScroll) {
                $timeout(function() {
                    $scope.scroll = newScroll;
                });
            });

        $scope.$on("zoomSelected",
            function (context, newZoom) {
                svgBuild.zoom(newZoom);
            });

        $scope.$on("scrollChange",
            function (context, values) {
                $scope.scroll[values.axis] = values.value;
                svgBuild.scroll($scope.scroll);
            });

    }]);

svgBuildController.directive('comboControl', ['$timeout', function ($timeout) {

    return {
        scope: {
            rootData: '@',
            listField: '@',
            valueField: '@',
            textField: '@',
            hideField: '@',
            changeEvent: '@',
            selectEvent: '@',
            fieldLabel: '@',
            selectedItem: '@',
            name: '@'
        },
        link: function ($scope, element, attrs) {
            $scope.update = function () {
                $scope.hideText = true;
                $scope.$emit($scope.selectEvent, $scope.selectedItem);
            }
        },
        controller: ('comboController', ['$scope', function ($scope) {

            var parentScopeModel = $scope.$parent[$scope.rootData];

            function updateScope() {
                $scope.listItems = parentScopeModel[$scope.listField];
                $scope.text = parentScopeModel[$scope.textField];
                $scope.value = parentScopeModel[$scope.valueField];
                $scope.hideText = $scope.text === "";
            }

            updateScope();

            $scope.$on($scope.changeEvent, function () {
                $timeout(function () {
                    updateScope();
                });
            });

        }]),
        template:
            '<div class={{class}} ng-hide="{{hideField}}">' +
            ' <label for="{{name}}">{{fieldLabel}}</label>' +
              '<div class="combo">' +
                  '<select ng-model="selectedItem" name="{{name}}" ng-click="selectClicked()" ng-change="update()" ng-blur="selectBlurred()" ng-options="x.id as x.name for x in listItems track by x.id"></select>' +
                  '<input ng-hide="hideText" type="text" ng-model="text" />' +
              '</div>' +
           '</div>'
    }
}]);

svgBuildController.directive('colorPalette', ['$rootScope', '$document', function ($rootScope, $document) {
    return {
        scope: {},
        link: function ($scope, element, attr) {
            if (!colorData) {

                var xml = new JKL.ParseXML("defrgb.xml");
                xml.async(function(result) {
                    var colors = result.palette.colors.page.color;
                    var colorNames = result.palette.localization.resource;
                    var colorData = [];
                    var loc = $rootScope.utils.getLoc();

                    var colorNameIndex = {};
                    colorNames.forEach(function(resource, index) {
                        colorNameIndex[resource.id] = index;
                    });

                    colors.forEach(function(color, index) {
                        var hexColor = "#";
                        var rgb = [];
                        color.tints.split(",")
                            .forEach(function(value) {
                                var colorValue = Number(value) * 255;
                                rgb.push(colorValue);
                                hexColor += $rootScope.utils.getHex(colorValue);
                            });

                        var hsl = colorConverter.rgbToHsl(rgb[0], rgb[1], rgb[2]);
                        colorData[index] = {
                            name: colorNames[colorNameIndex[color.resid]][loc],
                            color: hexColor,
                            style: "background-color:" +
                                hexColor +
                                ";" +
                                "color:" +
                                (hsl.lightness > 0.6 ? "#000" : "#FFF")
                        };

                    });
                    $scope.colors = colorData;
                    svgBuild.debugMessage(colorData);
                });
                xml.parse();
            } else {
                $scope.colors = colorData
            }

            var scrollElementParent = element.find("div").find("div").find("div");
            var scrollElement = scrollElementParent.find("div");
            var offset = 0;
            var interval = null;
            var timeout = null;
            var maxOffset;
            var isDown = false;

            $scope.startScroll = function (up) {
                move(up);
                maxOffset = $rootScope.utils.getRect(scrollElement).height -
                    $rootScope.utils.getRect(scrollElementParent).height;
                $scope.endScroll();
                isDown = true;
                timeout = setTimeout(function() {
                    if (isDown) {
                        interval = setInterval(function() {
                            if (isDown) {
                                move(up);
                            }
                        }, 70);
                    }
                }, 1000);
            };

            $scope.endScroll = function () {
                isDown = false;
                if (timeout !== null) clearTimeout(timeout);
                if (interval !== null) clearInterval(interval);
                timeout = null;
                interval = null;
            };

            function move(up) {
                offset += (up ? -15 : 15);
                offset = offset < 0 ? 0 : offset > maxOffset ? maxOffset : offset;
                $rootScope.utils.applyCss(scrollElement, "top", -offset + "px");
            }
        },
        template: '<div><button class="up" ng-mousedown="startScroll(true)" ng-mouseup="endScroll()"></button><span id="emptyColor"></span>' +
            '<div><div><div><span ng-repeat="color in colors" style={{color.style}}>' +
            '{{color.name}}</span></div></div></div><button class="down" ng-mousedown="startScroll(false)" ng-mouseup="endScroll()"></button></div>'
    };
}]);



svgBuildController.directive('scrollElement', ['$rootScope', '$document', function ($rootScope, $document) {
    return {
        scope: {
            scrollAxis: '@',
            moveEvent: '@',
            valueModel: '@',
            hideButton: '@'
        },
        link: function ($scope, element, attr) {

            var start = 0,
                move = 0,
                isSet = false,
                clientY = "client" + $scope.scrollAxis.toUpperCase(),
                isVertical = $scope.scrollAxis === "y",
                topAttr = isVertical ? "top" : "left",
                heightAttr = isVertical ? "height" : "width",
                bottomAttr = isVertical ? "bottom" : "right",
                leftAttr = isVertical ? "left" : "top",
                clientX = "client" + (isVertical ? "X" : "Y"),
                buttonPosition,
                buttonRect,
                elementRect,
                top,
                button = element.find("button"),
                scrollElement = button.parent(),
                buttonClicked = false,
                maxButtonPosition,
                lastButtonPosition,
                utils = $rootScope.utils;


            function getPositions() {
                buttonRect = utils.getRect(button);
                elementRect = utils.getRect(scrollElement);
                top = elementRect[topAttr];

                buttonPosition = buttonRect[topAttr] - top;
                maxButtonPosition = elementRect[heightAttr] - buttonRect[heightAttr];
            }

            function mouseDown(event) {

                getPositions();
                maxButtonPosition = elementRect[bottomAttr] - top - buttonRect[heightAttr];
                start = event[clientY];
                buttonClicked = true;
                $document.bind('mousemove', mousemove);
                $document.bind('mouseup', mouseup);
                $document.bind('blur', mouseup);
                return false;
            }


            function moveMouse(newButtonPosition) {
                lastButtonPosition = Math.min(Math.max(0, newButtonPosition), maxButtonPosition);
                $scope.$emit($scope.moveEvent, {
                    value: lastButtonPosition / maxButtonPosition,
                    axis: $scope.scrollAxis,
                });
                $rootScope.utils.applyCss(button, topAttr, lastButtonPosition + "px");
            }

            function mousemove(event) {
                move = event[clientY] - start;
                moveMouse(buttonPosition + move);
                if (event[clientX] < $rootScope.utils.getRect(button)[leftAttr]) {
                    mouseup();
                }
                return false;
            }

            function mouseup() {
                buttonClicked = false;
                moveMouse(lastButtonPosition, true);
                $document.unbind('mousemove', mousemove);
                $document.unbind('mouseup', mouseup);
            }

            function setScrollPosition(position) {
                getPositions();
                lastButtonPosition = maxButtonPosition * position;
                utils.applyCss(button, topAttr, lastButtonPosition + "px");
            }

            button.bind("mousedown", mouseDown);

            scrollElement.bind("mousedown", function (event) {
                if (!buttonClicked) {
                    getPositions();
                    moveMouse(event[clientY] - top - buttonRect[heightAttr] / 2, false);
                    mouseDown(event);
                }
                return false;
            });

            $scope.$parent.$watch($scope.valueModel + "." + $scope.scrollAxis,
                function (newValue, oldValue) {
                    if (!isSet || newValue !== oldValue) {
                        isSet = true;
                        setScrollPosition(newValue);
                    }
                });

            $scope.scrollClick = function (up) {
                moveMouse(lastButtonPosition + (up ? -1 : 1));
            }

        },
        template: '<div><span class="upButton" ng-click="scrollClick(true)"></span>' +
            '<div><div><button></button></div></div>' +
            '<span class="downButton" ng-click="scrollClick(false)"></span></div>'
    };
}]);



